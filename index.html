<!doctype html>
<html class="light" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <title>Dashboard por Sedes — Interactivo</title>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#334499",
            "excel-green": "#1D6F42",
            "background-light": "#f2f2f7",
            "background-dark": "#1c1c1e",
            "chart-1": "#334499",
            "chart-2": "#4C6EF5",
            "chart-3": "#22B8CF",
            "chart-4": "#20C997",
            "chart-5": "#FAB005",
          },
          fontFamily: { "display": ["Public Sans", "sans-serif"] },
          borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px" }
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    body { font-family: 'Public Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    .ios-blur { @apply backdrop-blur-xl bg-white/80 dark:bg-black/80; }
    .ios-card { @apply bg-white dark:bg-[#2c2c2e] rounded-xl border border-gray-200 dark:border-gray-800; }
    input[type="date"], select { @apply text-sm bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 rounded-lg focus:ring-primary focus:border-primary w-full px-3 py-2; }
    .pie-chart-container { position: relative; width: 160px; height: 160px; }
    .pie-chart { border-radius: 50%; width: 100%; height: 100%; }
    .pie-chart-inner { @apply absolute inset-[25%] bg-white dark:bg-[#2c2c2e] rounded-full flex flex-col items-center justify-center shadow-inner; }
  </style>

  <style>
    body { min-height: max(884px, 100dvh); }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen flex flex-col font-display transition-colors duration-300">

  <nav class="sticky top-0 z-50 ios-blur border-b border-gray-200 dark:border-gray-800">
    <div class="flex items-center justify-between px-4 py-3">
      <button id="menu-btn" class="flex items-center text-primary dark:text-blue-400" aria-label="Abrir menú">
        <span class="material-symbols-outlined text-[24px]">menu</span>
      </button>
      <h1 class="text-[#101218] dark:text-white text-base font-semibold leading-tight text-center flex-1">Dashboard por Sedes</h1>
      <div class="w-8" aria-hidden="true"></div>
    </div>
  </nav>

  <main class="flex-1 max-w-md mx-auto w-full p-4 space-y-6 pb-24">
    <!-- KPI cards -->
    <div class="grid grid-cols-2 gap-3">
      <div class="ios-card p-4 flex flex-col items-center justify-center text-center">
        <span class="text-[10px] font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-tight mb-1">Satisfacción</span>
        <div class="flex items-baseline gap-1">
          <span id="kpi-sat" class="text-2xl font-bold text-primary dark:text-blue-400">4.2</span>
          <span class="text-xs text-gray-400">/5</span>
        </div>
        <div class="flex text-yellow-400 mt-1" aria-hidden="true">
          <span class="material-symbols-outlined text-sm fill-1">star</span>
          <span class="material-symbols-outlined text-sm fill-1">star</span>
          <span class="material-symbols-outlined text-sm fill-1">star</span>
          <span class="material-symbols-outlined text-sm fill-1">star</span>
          <span class="material-symbols-outlined text-sm">star_half</span>
        </div>
      </div>

      <div class="ios-card p-4 flex flex-col items-center justify-center text-center">
        <span class="text-[10px] font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-tight mb-1">Total Quejas</span>
        <span id="kpi-count" class="text-2xl font-bold text-[#101218] dark:text-white">1,284</span>
        <span id="kpi-change" class="text-[10px] text-red-500 font-medium mt-1">+12% vs mes ant.</span>
      </div>
    </div>

    <!-- Filters -->
    <div class="ios-card p-4 shadow-sm border-primary/10">
      <div class="flex items-center gap-2 mb-4 border-b border-gray-100 dark:border-gray-800 pb-2">
        <span class="material-symbols-outlined text-primary text-xl">filter_alt</span>
        <h3 class="text-sm font-bold text-[#101218] dark:text-white">Filtros de Análisis</h3>
      </div>

      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-1">
            <label class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase ml-1">Fecha Inicio</label>
            <input id="filter-start" type="date" value="2023-10-01"/>
          </div>
          <div class="space-y-1">
            <label class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase ml-1">Fecha Fin</label>
            <input id="filter-end" type="date" value="2023-10-12"/>
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase ml-1">Sede Judicial</label>
          <select id="filter-sede" aria-label="Sede">
            <option value="">Todas las sedes</option>
            <option value="Plaza Castilla">Plaza Castilla</option>
            <option value="Princesa">Princesa</option>
            <option value="Poeta Joan Maragall">Poeta Joan Maragall</option>
            <option value="Francisco Gervás">Francisco Gervás</option>
            <option value="Santiago Audiencia Provincial">Santiago Audiencia Provincial</option>
          </select>
        </div>

        <div class="mt-2">
          <button id="btn-update" class="w-full bg-primary text-white hover:bg-primary/90 transition-colors py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-sm">refresh</span>
            Actualizar Resultados
          </button>
        </div>
      </div>
    </div>

    <!-- Pie + legend -->
    <div class="ios-card p-5">
      <h3 class="text-sm font-bold text-[#101218] dark:text-white mb-6 flex items-center gap-2">
        <span class="material-symbols-outlined text-lg text-primary">pie_chart</span>
        Distribución por Sedes
      </h3>

      <div class="flex flex-col items-center gap-6">
        <div class="pie-chart-container" aria-hidden="true">
          <div id="pie" class="pie-chart" style="background: conic-gradient(#334499 0% 100%);"></div>
          <div class="pie-chart-inner">
            <span id="pie-total" class="text-lg font-bold text-[#101218] dark:text-white">0</span>
            <span class="text-[8px] text-gray-400 uppercase">Total</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-x-6 gap-y-3 w-full px-2" id="pie-legend">
          <!-- legend items updated by JS -->
        </div>
      </div>
    </div>

    <!-- Export -->
    <div class="px-2">
      <button id="btn-export" class="w-full bg-excel-green hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-excel-green/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
        <span class="material-symbols-outlined text-[24px]">description</span>
        Exportar a CSV
      </button>
      <p class="text-[10px] text-center text-gray-500 mt-2 italic">La exportación aplicará los filtros de fecha y sede seleccionados.</p>
    </div>

    <!-- Problems -->
    <div class="ios-card overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
        <h3 class="text-sm font-bold text-[#101218] dark:text-white">Problemas más comunes</h3>
        <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">Vista Admin</span>
      </div>

      <div class="p-4" id="problems-list">
        <!-- problem bars updated by JS -->
      </div>
    </div>

    <!-- Table -->
    <div class="ios-card overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
        <h3 class="text-sm font-bold text-[#101218] dark:text-white">Registros Filtrados</h3>
        <span id="live-badge" class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">Vista Admin</span>
      </div>

      <div class="overflow-x-auto">
        <table id="results-table" class="w-full text-left">
          <thead>
            <tr class="bg-gray-50 dark:bg-gray-800/50">
              <th class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase">Fecha</th>
              <th class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase">Sede</th>
              <th class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase text-center">Cal.</th>
              <th class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase">Problema</th>
            </tr>
          </thead>
          <tbody id="results-body" class="divide-y divide-gray-100 dark:divide-gray-800">
            <!-- rows updated by JS -->
          </tbody>
        </table>
      </div>

      <div class="px-4 py-3 text-center border-t border-gray-100 dark:border-gray-800">
        <button id="btn-all" class="text-primary dark:text-blue-400 text-xs font-semibold">Ver todos los registros de esta sede</button>
      </div>
    </div>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 ios-blur border-t border-gray-200 dark:border-gray-800 pb-safe-area-bottom">
    <div class="max-w-md mx-auto flex justify-around items-center py-2 px-6">
      <button class="flex flex-col items-center gap-0.5 text-primary" aria-label="Ir al dashboard">
        <span class="material-symbols-outlined text-[24px]">dashboard</span>
        <span class="text-[10px] font-medium">Dashboard</span>
      </button>
      <button class="flex flex-col items-center gap-0.5 text-gray-400" aria-label="Entradas">
        <span class="material-symbols-outlined text-[24px]">list_alt</span>
        <span class="text-[10px] font-medium">Entradas</span>
      </button>
      <button class="flex flex-col items-center gap-0.5 text-gray-400" aria-label="Ajustes">
        <span class="material-symbols-outlined text-[24px]">settings</span>
        <span class="text-[10px] font-medium">Ajustes</span>
      </button>
    </div>
  </footer>

  <!-- ARIA live region for announcements -->
  <div id="announcer" class="sr-only" aria-live="polite"></div>

  <script>
    // Mock dataset (replace or fetch from API)
    const mockData = [
      { date: '2023-10-12', sede: 'Plaza Castilla', issue: 'Retrasos injustificados', rating: 2 },
      { date: '2023-10-12', sede: 'Princesa', issue: 'Dificultad de acceso', rating: 5 },
      { date: '2023-10-11', sede: 'Francisco Gervás', issue: 'Justicia Digital', rating: 3 },
      { date: '2023-10-10', sede: 'Plaza Castilla', issue: 'Retrasos injustificados', rating: 1 },
      { date: '2023-10-09', sede: 'Poeta Joan Maragall', issue: 'Trato desconsiderado', rating: 2 },
      { date: '2023-10-07', sede: 'Plaza Castilla', issue: 'Retrasos injustificados', rating: 4 },
      { date: '2023-10-05', sede: 'Princesa', issue: 'Justicia Digital', rating: 4 },
      { date: '2023-10-04', sede: 'Santiago Audiencia Provincial', issue: 'Dificultad de acceso', rating: 3 },
      { date: '2023-10-03', sede: 'Francisco Gervás', issue: 'Justicia Digital', rating: 2 },
      { date: '2023-10-02', sede: 'Poeta Joan Maragall', issue: 'Trato desconsiderado', rating: 3 }
      // add more records as needed
    ];

    // Utilities
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const parseDate = s => s ? new Date(s + 'T00:00:00') : null;
    const formatDate = (s) => {
      const d = new Date(s);
      return d.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
    };

    // DOM references
    const startInput = qs('#filter-start');
    const endInput = qs('#filter-end');
    const sedeSelect = qs('#filter-sede');
    const btnUpdate = qs('#btn-update');
    const btnExport = qs('#btn-export');
    const btnAll = qs('#btn-all');

    const kpiCount = qs('#kpi-count');
    const kpiSat = qs('#kpi-sat');
    const kpiChange = qs('#kpi-change');
    const pie = qs('#pie');
    const pieTotal = qs('#pie-total');
    const pieLegend = qs('#pie-legend');
    const problemsList = qs('#problems-list');
    const resultsBody = qs('#results-body');
    const announcer = qs('#announcer');

    // Initial render using default filter values
    function getFilteredData(startStr, endStr, sede) {
      const start = parseDate(startStr);
      const end = parseDate(endStr);
      return mockData.filter(r => {
        const d = parseDate(r.date);
        if (start && d < start) return false;
        if (end && d > end) return false;
        if (sede && sede !== '' && r.sede !== sede) return false;
        return true;
      });
    }

    function computePrevRange(startStr, endStr) {
      const start = parseDate(startStr);
      const end = parseDate(endStr);
      if (!start || !end) return null;
      const len = (end - start) + 24*3600*1000; // inclusive length in ms
      const prevEnd = new Date(start.getTime() - 24*3600*1000);
      const prevStart = new Date(prevEnd.getTime() - (len - 24*3600*1000));
      return { prevStart, prevEnd };
    }

    function percentChange(current, previous) {
      if (previous === 0) return current === 0 ? 0 : 100;
      return Math.round(((current - previous) / previous) * 100);
    }

    function updateKPIs(filtered, startStr, endStr) {
      const total = filtered.length;
      const avg = total === 0 ? 0 : (filtered.reduce((s, r) => s + r.rating, 0) / total);
      kpiCount.textContent = total.toLocaleString();
      kpiSat.textContent = avg ? (Math.round(avg * 10) / 10).toFixed(1) : '0.0';

      // compute previous period comparison
      const prevRange = computePrevRange(startStr, endStr);
      let prevCount = 0;
      if (prevRange) {
        const prevFiltered = mockData.filter(r => {
          const d = parseDate(r.date);
          return d >= prevRange.prevStart && d <= prevRange.prevEnd && (sedeSelect.value === '' || sedeSelect.value === r.sede);
        });
        prevCount = prevFiltered.length;
      }
      const change = percentChange(total, prevCount);
      if (change > 0) {
        kpiChange.textContent = `+${change}% vs periodo anterior`;
        kpiChange.className = 'text-[10px] text-green-600 font-medium mt-1';
      } else if (change < 0) {
        kpiChange.textContent = `${change}% vs periodo anterior`;
        kpiChange.className = 'text-[10px] text-red-500 font-medium mt-1';
      } else {
        kpiChange.textContent = `0% vs periodo anterior`;
        kpiChange.className = 'text-[10px] text-gray-500 font-medium mt-1';
      }
    }

    function updatePie(filtered) {
      // group by sede
      const counts = {};
      filtered.forEach(r => { counts[r.sede] = (counts[r.sede] || 0) + 1; });
      const total = filtered.length;
      const entries = Object.entries(counts).sort((a,b) => b[1]-a[1]);

      // build conic-gradient stops
      let acc = 0;
      const colors = ['#334499','#4C6EF5','#22B8CF','#20C997','#FAB005'];
      const stops = entries.map(([,c], i) => {
        const pct = Math.round((c / total) * 100);
        const start = acc;
        acc += pct;
        const end = acc;
        return `${colors[i % colors.length]} ${start}% ${end}%`;
      });
      // fill remaining to 100% if total > 0
      if (total === 0) {
        pie.style.background = 'conic-gradient(#E5E7EB 0% 100%)';
      } else {
        const gradient = 'conic-gradient(' + stops.join(', ') + ')';
        pie.style.background = gradient;
      }

      // update inner total
      pieTotal.textContent = total;

      // update legend
      pieLegend.innerHTML = '';
      entries.forEach(([sede, c], i) => {
        const pct = Math.round((c / total) * 100);
        const node = document.createElement('div');
        node.className = 'flex items-center gap-2';
        node.innerHTML = `
          <div class="w-3 h-3 rounded-sm" style="background:${colors[i % colors.length]}"></div>
          <div class="flex flex-col">
            <span class="text-[10px] text-gray-500 dark:text-gray-400 leading-none">${sede}</span>
            <span class="text-xs font-bold dark:text-white">${pct}%</span>
          </div>
        `;
        pieLegend.appendChild(node);
      });

      // if no entries, show placeholder legend items
      if (entries.length === 0) {
        pieLegend.innerHTML = '<div class="text-xs text-gray-400">No hay datos en el rango seleccionado.</div>';
      }
    }

    function updateProblems(filtered) {
      const counts = {};
      filtered.forEach(r => { counts[r.issue] = (counts[r.issue] || 0) + 1; });
      const total = filtered.length;
      const items = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);

      problemsList.innerHTML = '';
      if (items.length === 0) {
        problemsList.innerHTML = '<p class="text-xs text-gray-500">No hay problemas registrados en el periodo seleccionado.</p>';
        return;
      }

      items.forEach(([issue, c]) => {
        const pct = Math.round((c / total) * 100);
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-3';
        wrapper.innerHTML = `
          <div class="flex justify-between text-xs mb-1.5">
            <span class="font-medium dark:text-gray-300">${issue}</span>
            <span class="font-bold">${pct}%</span>
          </div>
          <div class="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full">
            <div class="h-full bg-primary rounded-full" style="width: ${pct}%;"></div>
          </div>
        `;
        problemsList.appendChild(wrapper);
      });
    }

    function updateTable(filtered) {
      resultsBody.innerHTML = '';
      if (filtered.length === 0) {
        resultsBody.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-xs text-gray-500">No se encontraron registros.</td></tr>`;
        return;
      }
      // show up to 50 rows (safe limit)
      filtered.slice(0, 50).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3 text-xs dark:text-gray-300">${formatDate(r.date)}</td>
          <td class="px-4 py-3 text-xs">
            <p class="font-medium dark:text-gray-200">${r.sede}</p>
            <p class="text-[10px] text-gray-400">${r.issue}</p>
          </td>
          <td class="px-4 py-3 text-xs text-center font-bold ${r.rating>=4 ? 'text-green-500': r.rating===3? 'text-orange-400' : 'text-red-500'}">${r.rating}</td>
          <td class="px-4 py-3 text-xs">${r.issue}</td>
        `;
        resultsBody.appendChild(tr);
      });
    }

    // Export CSV
    function exportCSV(filtered) {
      if (filtered.length === 0) {
        alert('No hay datos para exportar con los filtros actuales.');
        return;
      }
      const header = ['date','sede','issue','rating'];
      const rows = filtered.map(r => [r.date, r.sede, `"${r.issue.replace(/"/g,'""')}"`, r.rating]);
      const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Main update flow
    function runUpdate(announce = true) {
      const start = startInput.value;
      const end = endInput.value;
      const sede = sedeSelect.value;

      const filtered = getFilteredData(start, end, sede);

      updateKPIs(filtered, start, end);
      updatePie(filtered);
      updateProblems(filtered);
      updateTable(filtered);

      if (announce) {
        announcer.textContent = `${filtered.length} registros encontrados. KPIs y visualizaciones actualizadas.`;
      }
    }

    // Show all records (for selected sede)
    function showAllForSede() {
      const sede = sedeSelect.value;
      const filtered = sede ? mockData.filter(r => r.sede === sede) : mockData.slice();
      updateKPIs(filtered, '', '');
      updatePie(filtered);
      updateProblems(filtered);
      updateTable(filtered);
      announcer.textContent = `Mostrando todos los registros${sede ? ' para ' + sede : ''}.`;
    }

    // Event listeners
    btnUpdate.addEventListener('click', (e) => {
      e.preventDefault();
      runUpdate();
    });

    btnExport.addEventListener('click', (e) => {
      e.preventDefault();
      const filtered = getFilteredData(startInput.value, endInput.value, sedeSelect.value);
      exportCSV(filtered);
    });

    btnAll.addEventListener('click', (e) => {
      e.preventDefault();
      showAllForSede();
    });

    // init render
    runUpdate(false);
  </script>
</body>
</html>
